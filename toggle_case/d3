
bits 32

%MACRO EXIT 0
	MOV EBX,0
	MOV EAX,1
	INT 0X80
%ENDMACRO

;; rEADS FROM A FILE
;; @PARAM 1	fILE DESCRIPTOR
;; @PARAM 2	bUFFER
;; @PARAM 3	tEXT LENGTH
%MACRO READ 3
	MOV EDX,%3
	MOV ECX,%2
	MOV EBX,%1
	MOV EAX,3
	INT 0X80
%ENDMACRO
	
;; wRITES TO A FILE
;; @PARAM 1	fILE DESCRIPTOR
;; @PARAM 2	bUFFER
;; @PARAM 3	tEXT LENGTH
%MACRO WRITE 3
	MOV EDX,%3
	MOV ECX,%2
	MOV EBX,%1
	MOV EAX,4
	INT 0X80
%ENDMACRO

;; cLOSES A FILE
;; @PARAM 1	fILE DESCRIPTOR
%MACRO	CLOSE_FILE 1
	MOV EBX,%1
	MOV EAX,6	; SYS_CLOSE()
	INT 0X80	; kERNEL CALL
%ENDMACRO
	
;; fUNCTION THAT OPENS A FILE
;; @PARAM EBX	tHE NAME FILE
;; @PARAM EDX	1 FOR CREATE THE FILE IF DOESN'T EXIST, 0 OTHERWISE
OPEN_FILE:
	MOV ECX,2		; rEAD AND wRITE MODE
	MOV EAX,5		; SYS_OPEN()
	INT 0X80		; iNTERRUPTION 80. KERNEL CALL	

	TEST EAX,EAX		; cHECKS FOR ERRORS
	JNS _R_OPEN_FILE	; iF THERE IS NO ERROR RETURN

	;; iF THERE'S AN ERROR TRY TO CREATE THE FILE
	;; ONLY IF THE USER INDICATES IT
	CMP EDX,1
	JE _CREATE_FILE

	;; wRITES A MESSAGE AND EXITS THE PROGRAM IF THERE'S AN ERROR
	_ERR:
		WRITE 1, OPEN_FILE_ERROR, LEN_FNE
		EXIT

	;; cREATES THE FILE
	_CREATE_FILE:
		MOV ECX,0777	; pERMISSIONS
		MOV EAX,8	; SYS_CREAT()
		INT 0X80	; KERNEL CALL
		TEST EAX,EAX	; cHECKS FOR ERRORS
		JS _ERR		; sHOW A MESSAGE IF THERE'S AN ERROR
	
	_R_OPEN_FILE:	
	RET

;; cONVERTS CHARATER TO UPPER CASE
;; @PARAM EAX	tHE CHARACTER
TO_UPPER_CASE:
	;; iF THE CHARACTER IS NOT A LOWER CASE LETTER RETURN
	CMP EAX,97
	JL _RETURN_TUC
	CMP EAX,122
	JG _RETURN_TUC

	;; cONVERT TO uPPER CASE
	SUB EAX,32
	
	_RETURN_TUC:		; rETURN
	RET

;; cONVERTS CHARATER TO LOWER CASE
;; @PARAM EAX	tHE CHARACTER
TO_LOWER_CASE:
	;; iF THE CHARACTER IS NOT AN UPPER CASE LETTER RETURN
	CMP EAX,65
	JL _RETURN_TLC
	CMP EAX,90
	JG _RETURN_TLC

	;; cONVERT TO uPPER CASE
	ADD EAX,32
	
	_RETURN_TLC:		; rETURN
	RET

;; tOGGLES THE CASE OF THE CHARACTER
;; @PARAM EAX	tHE CHARACTER
TOGGLE_CASE:
	;; fROM UPPERCASE TO LOWERCASE
	;; iF THE CHARACTER IS NOT AN UPPER CASE LETTER CHECK IF IT'S LOWERCASE
	CMP EAX,65
	JL _CHECK_LW
	CMP EAX,90
	JG _CHECK_LW

	;; cONVERT TO uPPER CASE
	ADD EAX,32
	JMP _RETURN_TC

	;; fROM LOWERCASE TO UPPERCASE
	_CHECK_LW:
	;; iF THE CHARACTER IS NOT A LOWER CASE LETTER RETURN
	CMP EAX,97
	JL _RETURN_TC
	CMP EAX,122
	JG _RETURN_TC

	;; cONVERT TO uPPER CASE
	SUB EAX,32

	_RETURN_TC:	
	RET

SECTION .DATA
	OPEN_FILE_ERROR DB "eRROR: eRROR OPENING THE FILE"
	LEN_FNE EQU $ - OPEN_FILE_ERROR

SECTION .BSS
	SRC_FILE:	RESD 1  	; sOURCE FILE DESCRIPTOR 
	DEST_FILE:	RESD 1   	; dESTINATION FILE DESCRIPTOR
	BUFFER:		RESB 1		; bUFFER
	
SECTION .TEXT
	GLOBAL _START
	
_START:
	POP EBX			; ARGC
	POP EBX			; ARGV[0] NOMBRE DEL EJECUTABLE

	;; oPEN SRC FILE
	POP EBX			; sOURCE FILE NAME
	MOV EDX,0		; dON'T CREATE THE FILE
	CALL OPEN_FILE		; oPENS THE FILE
	MOV [SRC_FILE],EAX	; sAVES THE FILE DESCRIPTOR
	
	;; oPEN DEST FILE
	POP EBX			; DEST FILE NAME
	MOV EDX,1		; cREATE THE FILE IF NOT EXISTS
	CALL OPEN_FILE		; oPENS THE FILE
	MOV [DEST_FILE],EAX	; sAVES THE FILE DESCRIPTOR

	;; cONVERTS THE SRC FILE TO UPPER CASE CHAR BY CHAR AND SAVES IT INTO DEST FILE
	LP:
		;; rEADS ONE CHARACTER FORM THE SOURCE FILE
		READ [SRC_FILE], BUFFER, 1
	
		CMP EAX,0		; eof?
		JE _EXIT		; eXIT IF EOF IS REACHED

		MOV EAX,[BUFFER]

		CALL TOGGLE_CASE
		
		MOV [BUFFER],EAX

		;; wRITES ONE CHARACTER TO DEST FILE 
		WRITE [DEST_FILE], BUFFER, 1
	JMP LP
	
_EXIT:		
	CLOSE_FILE [SRC_FILE]
	CLOSE_FILE [DEST_FILE]
	EXIT
