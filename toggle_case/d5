
bits 32

%macro exit 0
	mov ebx,0
	mov eax,1
	int 0x80
%endmacro

;; reads from a file
;; @param 1	file descriptor
;; @param 2	buffer
;; @param 3	text length
%macro read 3
	mov edx,%3
	mov ecx,%2
	mov ebx,%1
	mov eax,3
	int 0x80
%endmacro
	
;; writes to a file
;; @param 1	file descriptor
;; @param 2	buffer
;; @param 3	text length
%macro write 3
	mov edx,%3
	mov ecx,%2
	mov ebx,%1
	mov eax,4
	int 0x80
%endmacro

;; closes a file
;; @param 1	file descriptor
%macro	close_file 1
	mov ebx,%1
	mov eax,6	; sys_close()
	int 0x80	; kernel call
%endmacro
	
;; function that opens a file
;; @param ebx	the name file
;; @param edx	1 for create the file if doesn't exist, 0 otherwise
open_file:
	mov ecx,2		; read and write mode
	mov eax,5		; sys_open()
	int 0x80		; interruption 80. kernel call	

	test eax,eax		; checks for errors
	jns _r_open_file	; if there is no error return

	;; if there's an error try to create the file
	;; only if the user indicates it
	cmp edx,1
	je _create_file

	;; writes a message and exits the program if there's an error
	_err:
		write 1, open_file_error, len_fne
		exit

	;; creates the file
	_create_file:
		mov ecx,0777	; permissions
		mov eax,8	; sys_creat()
		int 0x80	; kernel call
		test eax,eax	; checks for errors
		js _err		; show a message if there's an error
	
	_r_open_file:	
	ret

;; converts charater to upper case
;; @param eax	the character
to_upper_case:
	;; if the character is not a lower case letter return
	cmp eax,97
	jl _return_tuc
	cmp eax,122
	jg _return_tuc

	;; convert to upper case
	sub eax,32
	
	_return_tuc:		; return
	ret

;; converts charater to lower case
;; @param eax	the character
to_lower_case:
	;; if the character is not an upper case letter return
	cmp eax,65
	jl _return_tlc
	cmp eax,90
	jg _return_tlc

	;; convert to upper case
	add eax,32
	
	_return_tlc:		; return
	ret

;; toggles the case of the character
;; @param eax	the character
toggle_case:
	;; from uppercase to lowercase
	;; if the character is not an upper case letter check if it's lowercase
	cmp eax,65
	jl _check_lw
	cmp eax,90
	jg _check_lw

	;; convert to upper case
	add eax,32
	jmp _return_tc

	;; from lowercase to uppercase
	_check_lw:
	;; if the character is not a lower case letter return
	cmp eax,97
	jl _return_tc
	cmp eax,122
	jg _return_tc

	;; convert to upper case
	sub eax,32

	_return_tc:	
	ret

section .data
	open_file_error db "error: error opening the file"
	len_fne equ $ - open_file_error

section .bss
	src_file:	resd 1  	; source file descriptor 
	dest_file:	resd 1   	; destination file descriptor
	buffer:		resb 1		; buffer
	
section .text
	global _start
	
_start:
	pop ebx			; argc
	pop ebx			; argv[0] nombre del ejecutable

	;; open src file
	pop ebx			; source file name
	mov edx,0		; don't create the file
	call open_file		; opens the file
	mov [src_file],eax	; saves the file descriptor
	
	;; open dest file
	pop ebx			; dest file name
	mov edx,1		; create the file if not exists
	call open_file		; opens the file
	mov [dest_file],eax	; saves the file descriptor

	;; converts the src file to upper case char by char and saves it into dest file
	lp:
		;; reads one character form the source file
		read [src_file], buffer, 1
	
		cmp eax,0		; eof?
		je _exit		; exit if eof is reached

		mov eax,[buffer]
		call to_lower_case
		mov [buffer],eax

		;; writes one character to dest file 
		write [dest_file], buffer, 1
	jmp lp
	
_exit:		
	close_file [src_file]
	close_file [dest_file]
	exit
